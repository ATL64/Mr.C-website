<!doctype html>
<!--
* Mr. C - Question-Answering tool based on information from PubMed abstracts
* @version
* @link TBD
* Copyright 2021-2021 The Mr.C Authors
-->
<html lang="en">
	<head>
		<meta charset="utf-8"/>
		<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
		<meta http-equiv="X-UA-Compatible" content="ie=edge"/>
		<title>Mr. C - Mr. C - Question-Answering tool based on information from PubMed abstracts</title>
		<!-- Global site tag (gtag.js) - Google Analytics -->
		<script async src="https://www.googletagmanager.com/gtag/js?id=G-V40MCTNM7K"></script>
		<script>
			window.dataLayer = window.dataLayer || [];
			function gtag(){dataLayer.push(arguments);}
			gtag('js', new Date());

			gtag('config', 'G-V40MCTNM7K');
		</script>
		<!-- CSS files -->
		<link href="./dist/css/tabler.min.css" rel="stylesheet"/>
		<link href="./dist/css/tabler-flags.min.css" rel="stylesheet"/>
		<link href="./dist/css/tabler-payments.min.css" rel="stylesheet"/>
		<link href="./dist/css/tabler-vendors.min.css" rel="stylesheet"/>
		<link href="./dist/css/demo.min.css" rel="stylesheet"/>
	</head>
	<body class="antialiased">
		<div class="page">
			<aside class="navbar navbar-vertical navbar-expand-lg navbar-dark">
				<div class="container-fluid">
					<button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar-menu">
						<span class="navbar-toggler-icon"></span>
					</button>
					<h1 class="navbar-brand navbar-brand-autodark">
						<a href=".">
							<img src="./static/logo.png" width="150" height="90" alt="Mr. C">
						</a>
					</h1>
					<div class="collapse navbar-collapse" id="navbar-menu">
						<ul class="navbar-nav pt-lg-3">
							<li class="nav-item">
								<a class="nav-link" href="./mrc.html" >
									<span class="nav-link-icon d-md-none d-lg-inline-block"><svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><polyline points="5 12 3 12 12 3 21 12 19 12" /><path d="M5 12v7a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-7" /><path d="M9 21v-6a2 2 0 0 1 2 -2h2a2 2 0 0 1 2 2v6" /></svg>
									</span>
									<span class="nav-link-title">
										Mr. C
									</span>
								</a>
							</li>
							<li class="nav-item">
								<a class="nav-link" href="./about.html" >
									<span class="nav-link-icon d-md-none d-lg-inline-block"><svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M14 3v4a1 1 0 0 0 1 1h4" /><path d="M17 21h-10a2 2 0 0 1 -2 -2v-14a2 2 0 0 1 2 -2h7l5 5v11a2 2 0 0 1 -2 2z" /><line x1="9" y1="9" x2="10" y2="9" /><line x1="9" y1="13" x2="15" y2="13" /><line x1="9" y1="17" x2="15" y2="17" /></svg>
									</span>
									<span class="nav-link-title">
										About
									</span>
								</a>
							</li>
							<li class="nav-item">
								<a class="nav-link" href="./contact.html" >
									<span class="nav-link-icon d-md-none d-lg-inline-block"><svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><rect x="3" y="5" width="18" height="14" rx="2" /><polyline points="3 7 12 13 21 7" /></svg>
									</span>
									<span class="nav-link-title">
										Contact Us
									</span>
								</a>
							</li>
						</ul>
					</div>
				</div>
			</aside>
			<div class="content">
				<div class="container-xl">
					<!-- Page title -->
					<div class="page-header d-print-none">
						<div class="row align-items-center">
							<div class="col">
								<h2 class="page-title">
									Mr. C
								</h2>
							</div>
						</div>
					</div>
					<div class="alert alert-warning" role="alert">
						<h4 class="alert-title">Warning: This is a Beta Version</h4>
						<div class="text-muted">Mr. C is still in development phase. Please read the 'About' tab carefully before using it.</div>
					</div>
					<div class="row row-cards">
						<div class="col-12">
							<div class="card-body">
								<div class="row mb-3">
									<label class="form-label">Ask a question. Note that it needs to be a well formulated question in English.
										<span class="form-help" data-bs-toggle="popover" data-bs-placement="top" data-bs-html="true"
					data-bs-content="<p>Ask any question. Our algorithm will try to find its answers by analysing all the abstracts in the PubMed database.</p>
										">
										?</span>
								</label>
								<div class="input-group mb-2">
									<input type="text" class="form-control" placeholder="" id="input-question">
									<button class="btn" type="button" id="ask-button">Ask!</button>
								</div>
								<div class="invalid-feedback" id="invalid-input" style="display:none">Question too long. 200 characters max.</div>
							</div>
							<div class="row mb-5">
								<div class="col-xl-2">
									<label class="form-label">N Abstracts
										<span class="form-help" data-bs-toggle="popover" data-bs-placement="top" data-bs-html="true"
							data-bs-content="<p>Determines the maximum number of abstracts to be analysed by our algorithm.
											Bear in mind that currently the algorithm takes around 0.25 seconds per abstract, so the more abstracts
											you want to analyse, the longer it will take for the algorithm to provide an answer.
										</p>
										">
										?</span>
								</label>
								<select name="n-abstracts" class="form-select" id="n-abstracts">
									<option value="10" >10</option>
									<option value="30" >30</option>
									<option value="50" >50</option>
									<option value="100"  selected>100</option>
								</select>
							</div>
							<div class="col-xl-3">
								<label class="form-label">Year Range
									<span class="form-help" data-bs-toggle="popover" data-bs-placement="top" data-bs-html="true"
						data-bs-content="<p>Select the minimum and the maximum year to filter out articles that might not be of your interest.
									</p>
									">
									?</span>
							</label>
							<div class="row">
								<div class="col-xl-6">
									<select name="min-year" class="form-select" id="min-year">
										<option value="1860"  selected>1860</option>
										<option value="1861" >1861</option>
										<option value="1862" >1862</option>
										<option value="1863" >1863</option>
										<option value="1864" >1864</option>
										<option value="1865" >1865</option>
										<option value="1866" >1866</option>
										<option value="1867" >1867</option>
										<option value="1868" >1868</option>
										<option value="1869" >1869</option>
										<option value="1870" >1870</option>
										<option value="1871" >1871</option>
										<option value="1872" >1872</option>
										<option value="1873" >1873</option>
										<option value="1874" >1874</option>
										<option value="1875" >1875</option>
										<option value="1876" >1876</option>
										<option value="1877" >1877</option>
										<option value="1878" >1878</option>
										<option value="1879" >1879</option>
										<option value="1880" >1880</option>
										<option value="1881" >1881</option>
										<option value="1882" >1882</option>
										<option value="1883" >1883</option>
										<option value="1884" >1884</option>
										<option value="1885" >1885</option>
										<option value="1886" >1886</option>
										<option value="1887" >1887</option>
										<option value="1888" >1888</option>
										<option value="1889" >1889</option>
										<option value="1890" >1890</option>
										<option value="1891" >1891</option>
										<option value="1892" >1892</option>
										<option value="1893" >1893</option>
										<option value="1894" >1894</option>
										<option value="1895" >1895</option>
										<option value="1896" >1896</option>
										<option value="1897" >1897</option>
										<option value="1898" >1898</option>
										<option value="1899" >1899</option>
										<option value="1900" >1900</option>
										<option value="1901" >1901</option>
										<option value="1902" >1902</option>
										<option value="1903" >1903</option>
										<option value="1904" >1904</option>
										<option value="1905" >1905</option>
										<option value="1906" >1906</option>
										<option value="1907" >1907</option>
										<option value="1908" >1908</option>
										<option value="1909" >1909</option>
										<option value="1910" >1910</option>
										<option value="1911" >1911</option>
										<option value="1912" >1912</option>
										<option value="1913" >1913</option>
										<option value="1914" >1914</option>
										<option value="1915" >1915</option>
										<option value="1916" >1916</option>
										<option value="1917" >1917</option>
										<option value="1918" >1918</option>
										<option value="1919" >1919</option>
										<option value="1920" >1920</option>
										<option value="1921" >1921</option>
										<option value="1922" >1922</option>
										<option value="1923" >1923</option>
										<option value="1924" >1924</option>
										<option value="1925" >1925</option>
										<option value="1926" >1926</option>
										<option value="1927" >1927</option>
										<option value="1928" >1928</option>
										<option value="1929" >1929</option>
										<option value="1930" >1930</option>
										<option value="1931" >1931</option>
										<option value="1932" >1932</option>
										<option value="1933" >1933</option>
										<option value="1934" >1934</option>
										<option value="1935" >1935</option>
										<option value="1936" >1936</option>
										<option value="1937" >1937</option>
										<option value="1938" >1938</option>
										<option value="1939" >1939</option>
										<option value="1940" >1940</option>
										<option value="1941" >1941</option>
										<option value="1942" >1942</option>
										<option value="1943" >1943</option>
										<option value="1944" >1944</option>
										<option value="1945" >1945</option>
										<option value="1946" >1946</option>
										<option value="1947" >1947</option>
										<option value="1948" >1948</option>
										<option value="1949" >1949</option>
										<option value="1950" >1950</option>
										<option value="1951" >1951</option>
										<option value="1952" >1952</option>
										<option value="1953" >1953</option>
										<option value="1954" >1954</option>
										<option value="1955" >1955</option>
										<option value="1956" >1956</option>
										<option value="1957" >1957</option>
										<option value="1958" >1958</option>
										<option value="1959" >1959</option>
										<option value="1960" >1960</option>
										<option value="1961" >1961</option>
										<option value="1962" >1962</option>
										<option value="1963" >1963</option>
										<option value="1964" >1964</option>
										<option value="1965" >1965</option>
										<option value="1966" >1966</option>
										<option value="1967" >1967</option>
										<option value="1968" >1968</option>
										<option value="1969" >1969</option>
										<option value="1970" >1970</option>
										<option value="1971" >1971</option>
										<option value="1972" >1972</option>
										<option value="1973" >1973</option>
										<option value="1974" >1974</option>
										<option value="1975" >1975</option>
										<option value="1976" >1976</option>
										<option value="1977" >1977</option>
										<option value="1978" >1978</option>
										<option value="1979" >1979</option>
										<option value="1980" >1980</option>
										<option value="1981" >1981</option>
										<option value="1982" >1982</option>
										<option value="1983" >1983</option>
										<option value="1984" >1984</option>
										<option value="1985" >1985</option>
										<option value="1986" >1986</option>
										<option value="1987" >1987</option>
										<option value="1988" >1988</option>
										<option value="1989" >1989</option>
										<option value="1990" >1990</option>
										<option value="1991" >1991</option>
										<option value="1992" >1992</option>
										<option value="1993" >1993</option>
										<option value="1994" >1994</option>
										<option value="1995" >1995</option>
										<option value="1996" >1996</option>
										<option value="1997" >1997</option>
										<option value="1998" >1998</option>
										<option value="1999" >1999</option>
										<option value="2000" >2000</option>
										<option value="2001" >2001</option>
										<option value="2002" >2002</option>
										<option value="2003" >2003</option>
										<option value="2004" >2004</option>
										<option value="2005" >2005</option>
										<option value="2006" >2006</option>
										<option value="2007" >2007</option>
										<option value="2008" >2008</option>
										<option value="2009" >2009</option>
										<option value="2010" >2010</option>
										<option value="2011" >2011</option>
										<option value="2012" >2012</option>
										<option value="2013" >2013</option>
										<option value="2014" >2014</option>
										<option value="2015" >2015</option>
										<option value="2016" >2016</option>
										<option value="2017" >2017</option>
										<option value="2018" >2018</option>
										<option value="2019" >2019</option>
										<option value="2020" >2020</option>
										<option value="2021" >2021</option>
									</select>
								</div>
								<div class="col-xl-6">
									<select name="max-year" class="form-select" id="max-year">
										<option value="1860" >1860</option>
										<option value="1861" >1861</option>
										<option value="1862" >1862</option>
										<option value="1863" >1863</option>
										<option value="1864" >1864</option>
										<option value="1865" >1865</option>
										<option value="1866" >1866</option>
										<option value="1867" >1867</option>
										<option value="1868" >1868</option>
										<option value="1869" >1869</option>
										<option value="1870" >1870</option>
										<option value="1871" >1871</option>
										<option value="1872" >1872</option>
										<option value="1873" >1873</option>
										<option value="1874" >1874</option>
										<option value="1875" >1875</option>
										<option value="1876" >1876</option>
										<option value="1877" >1877</option>
										<option value="1878" >1878</option>
										<option value="1879" >1879</option>
										<option value="1880" >1880</option>
										<option value="1881" >1881</option>
										<option value="1882" >1882</option>
										<option value="1883" >1883</option>
										<option value="1884" >1884</option>
										<option value="1885" >1885</option>
										<option value="1886" >1886</option>
										<option value="1887" >1887</option>
										<option value="1888" >1888</option>
										<option value="1889" >1889</option>
										<option value="1890" >1890</option>
										<option value="1891" >1891</option>
										<option value="1892" >1892</option>
										<option value="1893" >1893</option>
										<option value="1894" >1894</option>
										<option value="1895" >1895</option>
										<option value="1896" >1896</option>
										<option value="1897" >1897</option>
										<option value="1898" >1898</option>
										<option value="1899" >1899</option>
										<option value="1900" >1900</option>
										<option value="1901" >1901</option>
										<option value="1902" >1902</option>
										<option value="1903" >1903</option>
										<option value="1904" >1904</option>
										<option value="1905" >1905</option>
										<option value="1906" >1906</option>
										<option value="1907" >1907</option>
										<option value="1908" >1908</option>
										<option value="1909" >1909</option>
										<option value="1910" >1910</option>
										<option value="1911" >1911</option>
										<option value="1912" >1912</option>
										<option value="1913" >1913</option>
										<option value="1914" >1914</option>
										<option value="1915" >1915</option>
										<option value="1916" >1916</option>
										<option value="1917" >1917</option>
										<option value="1918" >1918</option>
										<option value="1919" >1919</option>
										<option value="1920" >1920</option>
										<option value="1921" >1921</option>
										<option value="1922" >1922</option>
										<option value="1923" >1923</option>
										<option value="1924" >1924</option>
										<option value="1925" >1925</option>
										<option value="1926" >1926</option>
										<option value="1927" >1927</option>
										<option value="1928" >1928</option>
										<option value="1929" >1929</option>
										<option value="1930" >1930</option>
										<option value="1931" >1931</option>
										<option value="1932" >1932</option>
										<option value="1933" >1933</option>
										<option value="1934" >1934</option>
										<option value="1935" >1935</option>
										<option value="1936" >1936</option>
										<option value="1937" >1937</option>
										<option value="1938" >1938</option>
										<option value="1939" >1939</option>
										<option value="1940" >1940</option>
										<option value="1941" >1941</option>
										<option value="1942" >1942</option>
										<option value="1943" >1943</option>
										<option value="1944" >1944</option>
										<option value="1945" >1945</option>
										<option value="1946" >1946</option>
										<option value="1947" >1947</option>
										<option value="1948" >1948</option>
										<option value="1949" >1949</option>
										<option value="1950" >1950</option>
										<option value="1951" >1951</option>
										<option value="1952" >1952</option>
										<option value="1953" >1953</option>
										<option value="1954" >1954</option>
										<option value="1955" >1955</option>
										<option value="1956" >1956</option>
										<option value="1957" >1957</option>
										<option value="1958" >1958</option>
										<option value="1959" >1959</option>
										<option value="1960" >1960</option>
										<option value="1961" >1961</option>
										<option value="1962" >1962</option>
										<option value="1963" >1963</option>
										<option value="1964" >1964</option>
										<option value="1965" >1965</option>
										<option value="1966" >1966</option>
										<option value="1967" >1967</option>
										<option value="1968" >1968</option>
										<option value="1969" >1969</option>
										<option value="1970" >1970</option>
										<option value="1971" >1971</option>
										<option value="1972" >1972</option>
										<option value="1973" >1973</option>
										<option value="1974" >1974</option>
										<option value="1975" >1975</option>
										<option value="1976" >1976</option>
										<option value="1977" >1977</option>
										<option value="1978" >1978</option>
										<option value="1979" >1979</option>
										<option value="1980" >1980</option>
										<option value="1981" >1981</option>
										<option value="1982" >1982</option>
										<option value="1983" >1983</option>
										<option value="1984" >1984</option>
										<option value="1985" >1985</option>
										<option value="1986" >1986</option>
										<option value="1987" >1987</option>
										<option value="1988" >1988</option>
										<option value="1989" >1989</option>
										<option value="1990" >1990</option>
										<option value="1991" >1991</option>
										<option value="1992" >1992</option>
										<option value="1993" >1993</option>
										<option value="1994" >1994</option>
										<option value="1995" >1995</option>
										<option value="1996" >1996</option>
										<option value="1997" >1997</option>
										<option value="1998" >1998</option>
										<option value="1999" >1999</option>
										<option value="2000" >2000</option>
										<option value="2001" >2001</option>
										<option value="2002" >2002</option>
										<option value="2003" >2003</option>
										<option value="2004" >2004</option>
										<option value="2005" >2005</option>
										<option value="2006" >2006</option>
										<option value="2007" >2007</option>
										<option value="2008" >2008</option>
										<option value="2009" >2009</option>
										<option value="2010" >2010</option>
										<option value="2011" >2011</option>
										<option value="2012" >2012</option>
										<option value="2013" >2013</option>
										<option value="2014" >2014</option>
										<option value="2015" >2015</option>
										<option value="2016" >2016</option>
										<option value="2017" >2017</option>
										<option value="2018" >2018</option>
										<option value="2019" >2019</option>
										<option value="2020" >2020</option>
										<option value="2021"  selected>2021</option>
									</select>
								</div>
							</div>
						</div>
					</div>
					<!--------------------- ANSWER -------------------------->
					<h1 style="display:none" id="thinking">Thinking<span class="animated-dots"></span></h1>
					<!--------------------- QUEUE STATUS -------------------------->
					<div class="mb-3">
						<div class="row row-deck">
							<div class="col-xl-6">
								<div class="card">
									<div class="card-body p-2 text-center">
										<p>Number of requests in the queue: <b id="n-requests-queue">0</b></p>
									</div>
								</div>
							</div>
							<div class="col-xl-6">
								<div class="card">
									<div class="card-body p-2 text-center">
										<p>Your request is in position: <b id="job-queue-position">0</b></p>
									</div>
								</div>
							</div>
						</div>
					</div>
					<!--------------------- TOP CARDS -------------------------->
					<div class="mb-3 question-output" style="display:none">
						<div class="row row-deck">
							<!--
					<div class="col-xl-4">
						<div class="card">
							<div class="card-body p-2 text-center">
								<div class="h1 m-0" id="n-articles-with-keywords"></div>
								<div class="text-muted mb-3">Abstracts with Keywords in Database</div>
							</div>
						</div>
					</div>
					-->
							<div class="col-xl-6">
								<div class="card">
									<div class="card-body p-2 text-center">
										<div class="h1 m-0" id="n-analysed-abstracts"></div>
										<div class="text-muted mb-3">Number of Analysed Abstracts</div>
									</div>
								</div>
							</div>
							<div class="col-xl-6">
								<div class="card">
									<div class="card-body p-2 text-center">
										<div class="h1 m-0" id="n-valid-answers"></div>
										<div class="text-muted mb-3">Number of Abstracts with a Valid Answer</div>
									</div>
								</div>
							</div>
						</div>
					</div>
					<!--------------------- TABLES -------------------------->
					<div class="mb-3 question-output" style="display:none">
						<div class="row mb-3">
							<label class="form-label">
								Click on the rows of the tables below to view the details of each answer/article.
							</label>
						</div>
						<div class="row">
							<div class="col-xl-4">
								<div class="card" style="height: calc(24rem + 10px)">
									<div class="card-header">
										<h3 class="card-title">Answers</h3>
									</div>
									<div class="card-body card-body-scrollable">
										<table class="table card-table table-vcenter datatable">
											<thead>
												<tr>
													<th>Answer</th>
													<th>N</th>
												</tr>
											</thead>
											<tbody id="answers-table-body">
											</tbody>
										</table>
									</div>
								</div>
							</div>
							<div class="col-xl-8">
								<div class="card" style="height: calc(24rem + 10px)">
									<div class="card-header">
										<h3 class="card-title" id="articles-table-subtitle">Articles</h3>
									</div>
									<div class="card-body card-body-scrollable">
										<table class="table card-table table-vcenter datatable">
											<thead>
												<tr>
													<th>Title</th>
													<th>Authors</th>
													<th>Year</th>
													<th>Score</th>
												</tr>
											</thead>
											<tbody id="articles-table-body">
											</tbody>
										</table>
									</div>
								</div>
							</div>
						</div>
					</div>
					<!---------------------- MODALS ------------->
					<!-- Abstract Modal -->
					<div id="abstract-modal" class="modal modal-lg modal-dialog modal-dialog-centered" style="display:none">
						<!-- Modal content -->
						<div class="modal-content">
							<div class="modal-header">
								<h2 id=abstract-modal-title>Modal Header</h2>
							</div>
							<div class="modal-body">
								<h5 class="mb-3" id="modal-authors">Authors</h5>
								<p id=abstract-modal-body>Some text in the Modal Body</p>
							</div>
							<div class="modal-footer">
								<a href="" id="abstract-link" target="_blank"><b>View in PubMed</b></a>
							</div>
						</div>
					</div>
					<div class="modal-dialog modal-sm" role="document" id="error-modal" style="display:none">
						<div class="modal-content">
							<button type="button" class="btn-close error-modal-btn" data-bs-dismiss="modal" aria-label="Close"></button>
							<div class="modal-status bg-danger"></div>
							<div class="modal-body text-center py-4">
								<!-- Download SVG icon from http://tabler-icons.io/i/alert-triangle -->
								<!-- SVG icon code with class="mb-2 text-danger icon-lg" -->
								<h3>Error</h3>
								<div class="text-muted" id="error-modal-msg"></div>
							</div>
							<div class="modal-footer">
								<div class="w-100">
									<div class="row">
										<div class="col"><a href="#" class="btn btn-white w-100 error-modal-btn" data-bs-dismiss="modal">
												OK
											</a></div>
									</div>
								</div>
							</div>
						</div>
					</div>
					<!--------------------- RESULT FEEDBACK -------------------------->
					<div class="card mb-4" id="feedback-card" style="display:none">
						<div class="card-header">
							<h4 class="card-title">Answer Feedback</h4>
						</div>
						<div class="card-body">
							<div class="row mb-2">
								<p>
									We would love it if you could provide us with any feedback about the answers above.
									Answering the questions below and giving some extra feedback in the box will help us better understand how we can improve your experience.
								</p>
							</div>
							<div class="row mb-2">
								<div class="col-md-5 col-xl-4">
									How satisfied are you with Mr. C's answer?
								</div>
								<div class="col-md-7 col-xl-8">
									<select class="form-select" id="feedback-select">
										<option value="1">Very satisfied. Results are what I expected or better.</option>
										<option value="2">Satisfied. I found what I was looking for, but there are many irrelevant and wrong answers.</option>
										<option value="3">Neutral. I didn't find what I was looking for, but I kind of expected it.</option>
										<option value="4">Unsatisfied. No satisfactory answers were found and I think that they should have.</option>
									</select>
								</div>
							</div>
							<div class="row mb-2">
								<div class="col-md-5 col-xl-4">
									Which answer is the correct one?
								</div>
								<div class="col-md-7 col-xl-8">
									<input type="text" class="form-control" placeholder="" id="feedback-answer">
								</div>
							</div>
							<div class="row mb-1">
								<textarea class="form-control" id="feedback-text"></textarea>
							</div>
							<div class="row">
								<div class="col-md-8 col-xl-10"></div>
								<div class="col-md-4 col-xl-2">
									<button type="button" class="btn btn-primary form-footer" id="submit-feedback-button">Submit Feedback</button>
								</div>
							</div>
						</div>
					</div>
					<div style="text-align: center; display: none" id="feedback-thanks">
						<button class="btn btn-primary disabled">Thanks a lot for your feedback! We really appreciate it!</button>
					</div>
				</div>
			</div>
		</div>
		<!-- Import packages -->
		<script src="//code.jquery.com/jquery-3.2.1.min.js"></script>
		<script src="//cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js"></script>
		<script src="//maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"></script>
		<script>
			let server_url = 'http://34.107.125.243:5000/';

			let my_job_id = '';
			let last_job_id = '';
			function getQueueStatus() {

				$.ajax({
					url: server_url + 'queue',
					method: 'GET'
				})
				.done((res) => {
					$("#n-requests-queue").text(res.length);
					if (my_job_id.length != 0){
						let job_found = false;
						for (let i=0; i<res.job_ids.length; i++){
							if (res.job_ids[i]==my_job_id){
								$("#job-queue-position").text(i+1);
								job_found = true;
								break;
							}
						}
						if (!job_found){
							$("#job-queue-position").text("Your job is currently running!");
						}
						setTimeout(function() {
							getQueueStatus();
						}, 1000);
					} else {
						setTimeout(function() {
							getQueueStatus();
						}, 30000);
					}
				})
				.fail((err) => {
					window.location.href = 'error-500.html';
				});
			}
			getQueueStatus();

			// Getting cookies
			function getCookie(cname) {
				var name = cname + "=";
				var decodedCookie = decodeURIComponent(document.cookie);
				var ca = decodedCookie.split(';');
				for(var i = 0; i <ca.length; i++) {
					var c = ca[i];
					while (c.charAt(0) == ' ') {
						c = c.substring(1);
					}
					if (c.indexOf(name) == 0) {
						return c.substring(name.length, c.length);
					}
				}
				return "";
			}

			// Declare all relevant HTML items
			let n_analysed_abstracts = document.getElementById("n-analysed-abstracts");
			let n_valid_answers = document.getElementById("n-valid-answers");
			let n_abstracts_div = document.getElementById("n-abstracts");
			let min_year_div = document.getElementById("min-year");
			let max_year_div = document.getElementById("max-year");
			let input_question = document.getElementById("input-question");
			let thinking = document.getElementById("thinking");
			let question_output = document.getElementById("question-output");

			function show_error_modal(msg){
				$("#error-modal-msg").text(msg);
				$("#error-modal").show();
			}

			$(".error-modal-btn").on('click', function(){
				$("#error-modal").hide();
			});

			// ADD EVENT LISTENERS TO CONTROL THE INPUTS
			// Input question
			input_question.addEventListener('input', function(evt){
				if (this.value.length>200){
					$("#invalid-input").show();
					$("#ask-button").addClass("disabled");
					this.classList.add("is-invalid");
				} else {
					$("#invalid-input").hide();
					$("#ask-button").removeClass("disabled");
					this.classList.remove("is-invalid");
				}
			});
			// Focus on the Ask! button when typing the input question.
			$("#input-question").keyup(function(event) {
			if (event.keyCode === 13) {
				$("#ask-button").click();
			}
			});

			// Year Range
			min_year_div.addEventListener('input', function(evt){
				if (this.value>max_year_div.value){
					$("#ask-button").addClass("disabled");
					this.classList.add("is-invalid");
					max_year_div.classList.add("is-invalid");
				} else {
					$("#ask-button").removeClass("disabled");
					this.classList.remove("is-invalid");
					max_year_div.classList.remove("is-invalid");
				}
			});
			max_year_div.addEventListener('input', function(evt){
				if (this.value<min_year_div.value){
					$("#ask-button").addClass("disabled");
					this.classList.add("is-invalid");
					min_year_div.classList.add("is-invalid");
				} else {
					$("#ask-button").removeClass("disabled");
					this.classList.remove("is-invalid");
					min_year_div.classList.remove("is-invalid");
				}
			});

			// Ask question
			$("#ask-button").on("click", function(){
				// If one of my tasks is already running, don't allow to ask another one!
				if (my_job_id.length !== 0){
					let msg = "You already have a job in the queue. Wait until it finishes to ask another question!";
					show_error_modal(msg);
					return;
				}

				let bool_question_words = ['did', 'do', 'does', 'is', 'are', 'was', 'were', 'have', 'has', 'can', 'could', 'will', 'would'];
				for (const word of bool_question_words){
					if (input_question.value.toLowerCase().startsWith(word)){
						let msg = "It looks like your asking a Yes/No question. This is not supported yet!";
						show_error_modal(msg);
						return;
					}
				}

				change_visibility("question-output", "none");
				$("#abstract-modal").hide();
				$("#feedback-card").hide();
				// Show thinking message
				thinking.style.display = "flex";

				let ajax_data = {
					question: input_question.value,
					nOutputs: n_abstracts_div.value,
					min_year: min_year_div.value,
					max_year: max_year_div.value,
					username: getCookie("mrc_username"),
					password: getCookie("mrc_password"),
					pubmed: true
				};

				$.ajax({
					//url: server_url + "question",
					url: server_url + "question-pubmed",
					data: ajax_data,
					method: 'POST'
				})
				.done((res) => {
					if ("task_id" in res.data){
						my_job_id = res.data.task_id;
						last_job_id = res.data.task_id;
						getStatus(res.data.task_id);
					} else {
						let msg = "Your request wasn't accepted either because there are too many requests in the queue or because you already have a request enqueued.";
						show_error_modal(msg);
					}
				})
				.fail((err) => {
					if (err.status==401){
						window.location.href = 'error-401.html';
					} else if (err.status==404){
						window.location.href = 'error-404.html';
					} else {
						window.location.href = 'error-500.html';
					}
				});
			});

			function getStatus(taskID) {
				$.ajax({
					url: server_url + `tasks/${taskID}`,
					method: 'GET'
				})
				.done((res) => {
					let taskStatus = res.data.task_status;
					if (taskStatus === 'finished'){
						my_job_id = '';
						thinking.style.display = "none";
						$("#job-queue-position").text("0");
						$("#feedback-card").show();
						print_output(res.data.task_result);
						return false;
					}
					if (taskStatus === 'failed'){
						my_job_id = '';
						thinking.style.display = "none";
						return false;
					}
					setTimeout(function() {
						getStatus(res.data.task_id);
					}, 1000);
				})
				.fail((err) => {
					my_job_id = '';
					thinking.style.display = "none";
					window.location.href = 'error-500.html';
				});
			}

			function print_output(obj){
				obj = JSON.parse(obj);
				//$("#input-keywords").val(obj.keywords);
				if (!('total_n_articles' in obj)){
					show_error_modal("No abstracts answering your question were found.");
				} else if (count_properties(obj.pmid) == 0){
					let abstracts_error_str = "abstracts match";
					if (parseInt(obj.total_n_articles, 10) == 1){
						let abstracts_error_str = "abstract matches";
					}
					show_error_modal(obj.total_n_articles + " " + abstracts_error_str + " your question, but no answers were found.");
				} else {
					fill_answer_cards(obj);
					create_tables(obj, count_properties(obj.pmid));
					change_visibility("question-output", "block");
				}
			}

			function change_visibility(className, display) {
				let elements = document.getElementsByClassName(className),
						n = elements.length;
				for (let i = 0; i < n; i++) {
					let e = elements[i];
					e.style.display = display;
				}
			}

			function fill_answer_cards(obj){
				let num_abstracts = parseInt(obj.total_n_articles, 10);
				n_analysed_abstracts.innerText = Math.min(num_abstracts, n_abstracts_div.value).toString();
				let n_answers = count_properties(obj.pmid);
				n_valid_answers.innerText = n_answers.toString();
			}

			function create_tables(obj, n_answers){
				// Build answer counter to sort the data
				let counts = {};
				let scores = {};
				for (let i = 0; i < n_answers; i++) {
					counts[obj.final_answer[i]] = 1 + (counts[obj.final_answer[i]] || 0);
					scores[obj.final_answer[i]] = obj.start_score[i] + obj.end_score[i] + (scores[obj.final_answer[i]] || 0);
				}
				// sortable contains the sorted data in the form [[answer1, n1], [answer2, n2], ...]
				let sortable = [];
				for (let answer in counts) {
						sortable.push([answer, counts[answer], scores[answer] / counts[answer]]);
				}
				sortable.sort(function(a, b) {
					if (a[1]==b[1]){
						return b[2] - a[2];
					} else {
						return b[1] - a[1];
					}
				});

				let answers_table = document.getElementById("answers-table-body");
				answers_table.innerHTML = "";
				for (let answer in sortable){
					// Insert a row at the end of table
					let newRow = answers_table.insertRow();
					// Insert a cell at the end of the row
					let answerCell = newRow.insertCell();
					answerCell.appendChild(document.createTextNode(sortable[answer][0]));
					let nCell = newRow.insertCell();
					nCell.appendChild(document.createTextNode(sortable[answer][1]));
					newRow.classList.add("cursor-pointer");
					newRow.onclick = function(){
						generate_articles_table(obj, sortable[answer][0], n_answers);
					};
				}

				generate_articles_table(obj, sortable[0][0], n_answers);
			}

			function generate_articles_table(obj, answer, n_answers){
				$("articles-table-subtitle").text('Answer: '+answer);

				let articles_table = document.getElementById("articles-table-body");
				articles_table.innerHTML = "";

				let n_rows = 0;
				let article_index = 0;
				for (let i=0; i<n_answers; i++){
					if (obj.final_answer[i]==answer){
						n_rows += 1;
						article_index = i;
						let newRow = articles_table.insertRow();
						// Insert a cell at the end of the row
						let titleCell = newRow.insertCell();
						titleCell.appendChild(document.createTextNode(obj.article_title[i]));
						let authorsCell = newRow.insertCell();
						if (obj.authors[i].includes(',')){
							let first_author = obj.authors[i].substr(0, obj.authors[i].indexOf(','));
							authorsCell.appendChild(document.createTextNode(first_author+' et al.'));
						} else {
							authorsCell.appendChild(document.createTextNode(obj.authors[i]));
						}
						let yearCell = newRow.insertCell();
						yearCell.appendChild(document.createTextNode(obj.article_date[i].substring(0, 4)));
						let scoreCell = newRow.insertCell();
						scoreCell.appendChild(document.createTextNode((parseFloat(obj.start_score[i])+parseFloat(obj.end_score[i])).toFixed(2)));
						newRow.classList.add("cursor-pointer");
						newRow.onclick = function(){
							update_article_modal(obj, i);
						};
					}
				}
				if (n_rows===1){
					update_article_modal(obj, article_index);
				}
				sortTable("articles-table-body");
			}

			function sortTable(table_id) {
				let table, rows, switching, i, x, y, shouldSwitch;
				table = document.getElementById(table_id);
				switching = true;
				// Make a loop that will continue until no switching has been done
				while (switching) {
					// Start by saying: no switching is done:
					switching = false;
					rows = table.rows;
					// Loop through all table rows
					for (i = 0; i < (rows.length - 1); i++) {
						//start by saying there should be no switching:
						shouldSwitch = false;
						// Get the two elements you want to compare, one from current row and one from the next
						x = rows[i].getElementsByTagName("TD")[3]; // Score is in the 4th column
						y = rows[i + 1].getElementsByTagName("TD")[3]; // Score is in the 4th column
						//check if the two rows should switch place:
						if (parseFloat(x.innerHTML) < parseFloat(y.innerHTML)) {
							//if so, mark as a switch and break the loop:
							shouldSwitch = true;
							break;
						}
					}
					if (shouldSwitch) {
						// If a switch has been marked, make the switch and mark that a switch has been done
						rows[i].parentNode.insertBefore(rows[i + 1], rows[i]);
						switching = true;
					}
				}
			}

			function update_article_modal(obj, i){
				let abstract_text = obj.abstract[i];
				let answer = obj.answer[i];
				let regEx = new RegExp(answer, "ig");
				abstract_text = abstract_text.replace(regEx, "<span style='background-color:yellow;'>"+answer+"</span>");
				//abstract_text = abstract_text.replace(answer,"<span style='background-color:yellow;'>"+answer+"</span>");
				$("#abstract-modal-title").text(obj.article_title[i]);
				$("#abstract-modal-body").html(abstract_text);
				$("#modal-authors").text(obj.authors[i]);
				$("#abstract-link").attr("href", "https://pubmed.ncbi.nlm.nih.gov/" + obj.pmid[i]);
				$("#abstract-modal").show();
			}

			function count_properties(obj) {
				var count = 0;
				for(var prop in obj) {
					if(obj.hasOwnProperty(prop))
						++count;
				}
				return count;
			}

			$("#submit-feedback-button").on("click", function(){
				$("#feedback-card").hide();
				let ajax_data = {
					job_id: last_job_id,
					feedback_select: $("#feedback-select").val(),
					feedback_answer: $("#feedback-answer").val(),
					feedback_text: $("#feedback-text").val(),
					username: getCookie("mrc_username"),
					password: getCookie("mrc_password")
				};

				$.ajax({
					url: server_url + "feedback",
					data: ajax_data,
					method: 'POST'
				})
				.done((res) => {
					last_job_id = '';
					$('#feedback-thanks').show();
					setTimeout(function() {
						$('#feedback-thanks').fadeOut();
					}, 5000);
				})
				.fail((err) => {
					last_job_id = '';
					if (err.status==401){
						window.location.href = 'error-401.html';
					} else if (err.status==404){
						window.location.href = 'error-404.html';
					} else {
						window.location.href = 'error-500.html';
					}
				});
			})
		</script>
	</div>
	<footer class="footer footer-transparent d-print-none">
		<div class="container">
			<div class="row text-center align-items-center flex-row-reverse">
				<div class="col-12 col-lg-auto mt-3 mt-lg-0">
					<ul class="list-inline list-inline-dots mb-0">
						<li class="list-inline-item">
							Copyright &copy; 2021
							<a href="." class="link-secondary">Mr. C</a>.
							All rights reserved.
						</li>
					</ul>
				</div>
			</div>
		</div>
	</footer>
</div>
</div>
<!-- Libs JS -->
<!-- Tabler Core -->
<script src="./dist/js/tabler.min.js"></script>
</body>
</html>
